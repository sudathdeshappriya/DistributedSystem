version: '3.8'

services:
  backend:
    build: ../../backend
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5000
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=http://${VM1_PUBLIC_HOST_OR_IP}

      # Multi-VM etcd cluster (private IPs)
      - ETCD_HOSTS=http://${VM2_IP}:2379,http://${VM3_IP}:2379,http://${VM4_IP}:2379

      # Multi-VM MinIO nodes (private IPs; S3 port 9000)
      - MINIO_NODES=${VM2_IP}:9000,${VM3_IP}:9000,${VM4_IP}:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET_NAME=distributed-files
      - MINIO_USE_SSL=false

    ports:
      - "5000:5000"

  frontend:
    build:
      context: ../../frontend
      args:
        - REACT_APP_API_URL=http://${VM1_PUBLIC_HOST_OR_IP}:5000/api
    container_name: frontend
    restart: unless-stopped
    ports:
      - "80:80"

